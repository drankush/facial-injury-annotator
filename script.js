let inputDirHandle=null,outputDirHandle=null,fileHandles=[],currentImageIndex=0,canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),currentColor=null,isDrawing=!1,startX=0,startY=0,annotations={};const colorToInjury={red:"laceration",green:"abrasion",blue:"ecchymosis",yellow:"sutured_laceration",black:"dried_blood"};function checkReady(){const e=document.getElementById("slice");e.disabled=!inputDirHandle||!outputDirHandle}async function loadImage(e){const t=await e.getFile(),n=new Image;n.src=URL.createObjectURL(t),await new Promise((e=>n.onload=e)),canvas.width=n.width,canvas.height=n.height,ctx.drawImage(n,0,0),redrawImageWithAnnotations(),document.getElementById("image-name").textContent=e.name}function redrawImageWithAnnotations(){loadImage(fileHandles[currentImageIndex]).then((()=>{const e=annotations[fileHandles[currentImageIndex].name]||[];for(const{x:t,y:n,w:a,h:o,color:i}of e)ctx.strokeStyle=i,ctx.lineWidth=2,ctx.strokeRect(t,n,a,o)}))}document.getElementById("jump-btn").disabled=!0,document.getElementById("select-input-folder").addEventListener("click",(async()=>{inputDirHandle=await window.showDirectoryPicker(),fileHandles=[];for await(const e of inputDirHandle.values())"file"===e.kind&&/\.(jpe?g|png)$/i.test(e.name)&&fileHandles.push(e);fileHandles.sort(((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0}))),currentImageIndex=0,await loadImage(fileHandles[currentImageIndex]),document.getElementById("jump-btn").disabled=!1,checkReady()})),document.getElementById("select-output-folder").addEventListener("click",(async()=>{outputDirHandle=await window.showDirectoryPicker(),checkReady()})),document.getElementById("next").addEventListener("click",(async()=>{currentImageIndex<fileHandles.length-1&&(currentImageIndex++,await loadImage(fileHandles[currentImageIndex]))})),document.getElementById("prev").addEventListener("click",(async()=>{currentImageIndex>0&&(currentImageIndex--,await loadImage(fileHandles[currentImageIndex]))})),document.querySelectorAll(".tool").forEach((e=>{e.addEventListener("click",(()=>{currentColor=e.dataset.color}))})),canvas.addEventListener("mousedown",(e=>{if(!currentColor)return;const t=canvas.getBoundingClientRect();startX=e.clientX-t.left,startY=e.clientY-t.top,isDrawing=!0})),canvas.addEventListener("mouseup",(e=>{if(!isDrawing||!currentColor)return;const t=canvas.getBoundingClientRect(),n=e.clientX-t.left,a=e.clientY-t.top,o=Math.min(startX,n),i=Math.min(startY,a),r=Math.abs(n-startX),c=Math.abs(a-startY),d=fileHandles[currentImageIndex].name;annotations[d]||(annotations[d]=[]),annotations[d].push({x:o,y:i,w:r,h:c,color:currentColor}),redrawImageWithAnnotations(),isDrawing=!1})),document.getElementById("slice").addEventListener("click",(async()=>{const e=fileHandles[currentImageIndex],t=await e.getFile(),n=await createImageBitmap(t),a=e.name.replace(/\.(jpe?g|png)$/i,""),o=annotations[e.name]||[];let i={};for(const e of o){const t=colorToInjury[e.color];if(!t)continue;i[t]=(i[t]||0)+1;const o=`${a}_${t}_${String(i[t]).padStart(2,"0")}.jpg`,r=document.createElement("canvas");r.width=e.w,r.height=e.h;r.getContext("2d").drawImage(n,e.x,e.y,e.w,e.h,0,0,e.w,e.h);const c=await new Promise((e=>r.toBlob(e,"image/jpeg"))),d=await outputDirHandle.getFileHandle(o,{create:!0}),l=await d.createWritable();await l.write(c),await l.close()}alert(`Exported ${o.length} annotations.`)})),document.getElementById("jump-btn").addEventListener("click",(()=>{const e=document.getElementById("jump-input").value.trim().toLowerCase();if(!e)return;const t=fileHandles.findIndex((t=>t.name.toLowerCase().startsWith(e)));-1!==t?(currentImageIndex=t,loadImage(fileHandles[currentImageIndex])):alert(`No image found starting with '${e}'. Please try again.`)})),document.getElementById("undo").addEventListener("click",(()=>{const e=fileHandles[currentImageIndex].name;annotations[e]&&annotations[e].length>0&&(annotations[e].pop(),redrawImageWithAnnotations())}));
